//@version=5
indicator('Parabolic SAR', shorttitle='PSAR', overlay=true)

start = input.float(title='Start', step=0.001, defval=0.02)
increment = input.float(title='Increment', step=0.001, defval=0.02)
maximum = input.float(title='Maximum', step=0.01, defval=0.2)
width = input.int(title='Point Width', minval=1, defval=2)
highlightStartPoints = input(title='Highlight Start Points ?', defval=true)
showLabels = input(title='Show Buy/Sell Labels ?', defval=true)
highlightState = input(title='Highlight State ?', defval=true)

bull_color = input.color(color.green, title = 'Bull Color')
bear_color = input.color(color.red, title = 'Bear Color')

psar = ta.sar(start, increment, maximum)
dir = psar < close ? 1 : -1

psarColor = dir == 1 ? bull_color : bear_color
psarPlot = plot(psar, title='PSAR', style=plot.style_circles, linewidth=width, color=psarColor, display = display.none, editable = false)
plotshape(dir == 1 ? psar : na, title = 'PSAR Bull', location = location.absolute, style =shape.triangleup, color = bull_color)
plotshape(dir == -1 ? psar : na, title = 'PSAR Bear', location = location.absolute, style =shape.triangledown, color = bear_color)

// rsi
rsi_length = input.int(14, title = 'RSI Length', group = 'RSI Settings', inline = '1')
rsi_long = input.int(50, title = 'RSI Buy Above', group = 'RSI Settings', inline = '2')
rsi_stronglong = input.int(57, title = 'RSI Strong Buy Above', group = 'RSI Settings', inline = '3')
rsi_short = input.int(50, title = 'RSI Sell Below', group = 'RSI Settings', inline = '4')
rsi_strongshort = input.int(43, title = 'RSI Strong Sell Below', group = 'RSI Settings', inline = '5')

if rsi_stronglong < rsi_long
    runtime.error("RSI Strong Buy cannot be less than RSI Buy")
if rsi_strongshort > rsi_short
    runtime.error("RSI Strong Sell cannot be greater than RSI Sell")


rsi_value = ta.rsi(close, rsi_length)

var color longColor = bull_color
var color shortColor = bear_color

var int last_signal = 0

strongbuy = last_signal[1] != 1 and dir == 1 and rsi_value >= rsi_stronglong
buySignal = last_signal[1] != 1 and dir == 1 and rsi_value >= rsi_long

strongsell = last_signal[1] != -1 and dir == -1 and rsi_value <= rsi_strongshort
sellSignal = last_signal[1] != -1 and dir == -1 and rsi_value <= rsi_short

// barcolor(dir == 1 ? color.green : dir == -1 ? color.red : na)
last_signal := barstate.isfirst ? dir : (buySignal or strongbuy) ? 1 : (sellSignal or sellSignal) ? -1 : last_signal[1]

plotshape(buySignal and highlightStartPoints ? psar : na, title='Long Start', location=location.absolute, style=shape.circle, size=size.tiny, color=color.new(longColor, 0))
plotshape(buySignal and showLabels ? psar : na, title='Buy Label', text='Buy', location=location.absolute, style=shape.labelup, size=size.tiny, color=color.new(longColor, 0), textcolor=color.new(color.white, 0))
plotshape(strongbuy and showLabels ? psar : na, title='Strong Buy Label', text='Strong Buy', location=location.absolute, style=shape.labelup, size=size.tiny, color=color.new(longColor, 0), textcolor=color.new(color.white, 0))


plotshape(sellSignal and highlightStartPoints ? psar : na, title='Short Start', location=location.absolute, style=shape.circle, size=size.tiny, color=color.new(shortColor, 0))
plotshape(sellSignal and showLabels ? psar : na, title='Sell Label', text='Sell', location=location.absolute, style=shape.labeldown, size=size.tiny, color=color.new(shortColor, 0), textcolor=color.new(color.white, 0))
plotshape(strongsell and showLabels ? psar : na, title='Strong Sell Label', text='Strong Sell', location=location.absolute, style=shape.labeldown, size=size.tiny, color=color.new(shortColor, 0), textcolor=color.new(color.white, 0))

midPricePlot = plot(ohlc4, title='', display=display.none)

fillColor = highlightState ? dir == 1 ? longColor : shortColor : na
fill(midPricePlot, psarPlot, title='Trade State Filling', color=color.new(fillColor,90))

changeCond = dir != dir[1]
alertcondition(changeCond, title='Alert: PSAR Direction Change', message='PSAR has changed direction!')
alertcondition(buySignal, title='Alert: PSAR/RSI Long', message='PSAR/RSI Long')
alertcondition(sellSignal, title='Alert: PSAR/RSI Short', message='PSAR/RSI Sell')

