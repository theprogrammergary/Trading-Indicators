// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/

//@version=5
indicator("for_inti_untestedlines", overlay = true, max_lines_count = 500, max_bars_back = 5000)

//-----INPUTS-----//
number_of_days = 250
extension = input.bool(false, title = 'Extend Tested Lines Forever', group = 'Line Settings', inline = '2')

css_untested = input.color(color.new(color.white, 40), title = 'Untested', group = 'Line Settings', inline = '3')
style_untested = input.string('Solid', title = '', options = ['Solid', 'Dotted', 'Dashed'], group = 'Line Settings', inline = '3')
width_untested = input.int(1, title = '', minval = 1, maxval = 5, group = 'Line Settings', inline = '3')

css_tested = input.color(color.new(color.yellow,25), title = 'Tested  ', group = 'Line Settings', inline = '4')
style_tested = input.string('Dotted', title = '', options = ['Solid', 'Dotted', 'Dashed'], group = 'Line Settings', inline = '4')
width_tested = input.int(1, title = '', minval = 1, maxval = 5, group = 'Line Settings', inline = '4')
f_style_tested = (style_tested == 'Solid' ? line.style_solid : style_tested == 'Dashed' ? line.style_dashed : style_tested == 'Dotted' ? line.style_dotted : line.style_solid)
//-----INPUTS-----//



//-----FUNCTIONS-----//
//--FUNCTION TO ADD NEW AND REMOVE LAST IN ARRAY--//
f_array_add_pop(array, new_value_to_add) =>
    array.unshift(array, new_value_to_add)
    array.pop(array)
//--FUNCTION TO ADD NEW AND REMOVE LAST IN ARRAY--//


//--FUNCTION TO DRAW INITIAL LINES--//
f_new_lines(highs_array, lows_array) =>

    high_value = request.security(syminfo.tickerid, 'D', high[1], lookahead = barmerge.lookahead_on)
    low_value = request.security(syminfo.tickerid, 'D', low[1], lookahead = barmerge.lookahead_on)

    yesterday_time = request.security(syminfo.tickerid, 'D', time[1], lookahead = barmerge.lookahead_on)
    today_time = request.security(syminfo.tickerid, 'D', time, lookahead = barmerge.lookahead_on)

    // high line, delete oldest and then add new one
    line.delete( array.get(highs_array, array.size(highs_array) - 1) )
    f_array_add_pop(highs_array, line.new(x1 = yesterday_time, y1 = high_value, x2 = today_time, y2 = high_value, xloc = xloc.bar_time, extend = extend.right, color = css_untested, 
     style = (style_untested == 'Solid' ? line.style_solid : style_untested == 'Dashed' ? line.style_dashed : style_untested == 'Dotted' ? line.style_dotted : line.style_solid), width = width_untested))

    // low line, delete oldest and then add new one
    line.delete( array.get(lows_array, array.size(lows_array) - 1) )
    f_array_add_pop(lows_array, line.new(x1 = yesterday_time, y1 = low_value, x2 = today_time, y2 = low_value, xloc = xloc.bar_time, extend = extend.right, color = css_untested, 
     style = (style_untested == 'Solid' ? line.style_solid : style_untested == 'Dashed' ? line.style_dashed : style_untested == 'Dotted' ? line.style_dotted : line.style_solid), width = width_untested))
//--FUNCTION TO DRAW INITIAL LINES--//


//--FUNCTION TO CHANGE TO TESTED--//
f_check_4_test(highs_array, lows_array, highs_tested_array, lows_tested_array) =>
    
    for i = 0 to array.size(highs_array) - 1
        high_to_break = line.get_y2(array.get(highs_array,i))
        start_time = line.get_x1(array.get(highs_array,i))
        end_time = line.get_x2(array.get(highs_array,i))

        if high > high_to_break
            f_array_add_pop(lows_tested_array, line.new(x1 = start_time, y1 = high_to_break, x2 = time, y2 = high_to_break, xloc = xloc.bar_time, extend = extension ? extend.right : extend.none, color = css_tested, 
             style = (style_tested == 'Solid' ? line.style_solid : style_tested == 'Dashed' ? line.style_dashed : style_tested == 'Dotted' ? line.style_dotted : line.style_solid), width = width_tested))
            line.delete(array.get(highs_array, i))
            line.delete(array.get(highs_tested_array, array.size(lows_tested_array) - 1))


    for i = 0 to array.size(lows_array) - 1
        low_to_break = line.get_y2(array.get(lows_array,i))
        start_time = line.get_x1(array.get(lows_array,i))
        end_time = line.get_x2(array.get(lows_array,i))

        if low < low_to_break
            f_array_add_pop(lows_tested_array, line.new(x1 = start_time, y1 = low_to_break, x2 = time, y2 = low_to_break, xloc = xloc.bar_time, extend = extension ? extend.right : extend.none, color = css_tested, 
             style = (style_tested == 'Solid' ? line.style_solid : style_tested == 'Dashed' ? line.style_dashed : style_tested == 'Dotted' ? line.style_dotted : line.style_solid), width = width_tested))
            line.delete(array.get(lows_array, i))
            line.delete(array.get(lows_tested_array, array.size(lows_tested_array) - 1))

//--FUNCTION TO CHANGE TO TESTED--//
//-----FUNCTIONS-----//



//-----DEFINE VARIABLES-----//
//--ARRAYS FOR UNTESTED DAILY HIGH/LOWS--//
var untested_highs = array.new_line(number_of_days, na)
var untested_lows = array.new_line(number_of_days, na)
//--ARRAYS FOR UNTESTED DAILY HIGH/LOWS--//


//--ARRAYS FOR TESTED DAILY HIGH/LOWS--//
var tested_highs = array.new_line(number_of_days, na)
var tested_lows = array.new_line(number_of_days, na)
//--ARRAYS FOR TESTED DAILY HIGH/LOWS--//
//-----DEFINE VARIABLES-----//



//-----RUN CODE-----//
new_day = ta.change(time("D"))
// bgcolor(new_day ? color.new(color.red, 80) : na)

// draw new lines on a new day
if new_day
    f_new_lines(untested_highs, untested_lows)

// see if we need to switch lines to tested state
f_check_4_test(untested_highs, untested_lows, tested_highs, tested_lows)

//-----RUN CODE-----//
